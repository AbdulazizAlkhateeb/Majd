{% extends "main/base.html" %}
{% load static %}
{% block content %}
<div class="bg-light py-4" style="min-height: 100vh;">

  <!-- Academy Header -->
  <div class="bg-white border-bottom py-3 mb-4">
    <div class="container d-flex justify-content-between align-items-center" style="max-width: 1100px;">
      <!-- Left -->
      <div class="d-flex flex-column align-items-start">
        <div class="d-flex align-items-center">
          <a href="{% url 'academies:detail' academy.slug %}" class="text-dark me-3">
            <i class="bi bi-arrow-left fs-5"></i>
          </a>
          <div class="vr me-3"></div>
          {% if academy.logo %}
            <img src="{{ academy.logo.url }}" class="rounded me-2" width="36" height="36" style="object-fit:cover;">
          {% else %}
            <div class="rounded bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width:36px; height:36px;">
              {{ academy.name|slice:":1"|upper }}
            </div>
          {% endif %}
          <div>
            <span class="fw-semibold">{{ academy.name }}</span><br>
            <small><i class="bi bi-star-fill text-warning"></i> 4.9 â€¢ <i class="bi bi-geo-alt text-muted"></i> {{ academy.city }}</small>
          </div>
        </div>
        <div class="mt-3">
          <h4 class="mb-1" style="font-size: 28px;">Enroll Your Children</h4>
          <p class="text-muted small">Select children to enroll in <strong>{{ program.title }}</strong>.</p>
        </div>
      </div>
      <!-- Right -->
      <div class="text-end">
        <span class="text-muted small">Step 1 of 3</span>
        <div class="progress mt-1" style="height:4px; width:120px; margin-left:auto;">
          <div class="progress-bar bg-success" role="progressbar" style="width: 30%;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="container" style="max-width: 1100px;">

    <!-- Program Card -->
    <div class="card border rounded-3 p-4 mb-4">
      <div class="row align-items-center">
        
        <!-- Left Section -->
        <div class="col-md-8 d-flex flex-column justify-content-center">
          <div class="text-center text-md-start">
            <!-- Title -->
            <h6 class="fw-semibold mb-1">{{ program.title }}</h6>
            

            <!-- Description -->
            <p class="text-muted small mb-2">{{ program.short_description }}</p>

            <!-- Program Details -->
            <div class="text-muted small d-flex flex-wrap justify-content-center justify-content-md-start">
              <div class="me-3"><i class="bi bi-people me-1"></i> Ages {{ program.age_group_display|default:"N/A" }}</div>
            </div>
          </div>
        </div>

        <!-- Right Section -->
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <span class="badge membership-badge mb-3">Included with Membership</span>  
          <a href="{% url 'academies:program_sessions' academy.slug program.id %}" 
             class="btn btn-outline-success btn-custom mt-2">
            <i class="bi bi-calendar-event me-1"></i> View Sessions
          </a>
        </div>
      </div>
    </div>

    <!-- Children Heading -->
    <div class="d-flex justify-content-between align-items-center mt-4">
      <div>
        <h5 class="fw-bold mb-1">Select Children</h5>
        <p class="text-muted small mb-0">
          Choose which children to enroll in <strong>{{ program.title }}</strong>
        </p>
      </div>

      <!-- Selection Status -->
      <div id="selectionStatus" class="text-end">
        <small>
          <span id="childCount">0</span> child selected
        </small><br>
        <span class="badge membership-badge">Included with Membership</span>
      </div>
    </div>


      <!-- Children -->
      <form method="post" id="enrollForm" action="{% url 'academies:join_program_view' academy.slug program.id %}">
      {% csrf_token %}
      <input type="hidden" name="program" value="{{ program.id }}">
      <div class="row g-4 mt-2">
        {% for child in children %}
          <div class="col-md-4">
            <div class="card child-card border rounded-3 p-3 h-100 position-relative 
                        {% if not child.is_eligible or child.already_enrolled %}not-eligible{% endif %}"
                data-child-id="{{ child.id }}">

              <!-- Disable checkbox if not eligible -->
              <input class="form-check-input position-absolute top-0 end-0 m-2 child-checkbox"
                    type="checkbox" 
                    name="children" 
                    value="{{ child.id }}" 
                    id="child{{ child.id }}"
                    {% if not child.is_eligible or child.already_enrolled %}disabled{% endif %}
                    hidden>

              <div class="d-flex align-items-center">
                {% if child.profile_image %}
                  <img src="{{ child.profile_image.url }}" class="rounded-circle me-2" width="40" height="40" style="object-fit:cover;">
                {% else %}
                  <div class="avatar-circle me-2">{{ child.first_name|slice:":1"|upper }}</div>
                {% endif %}
                <div>
                  <h6 class="fw-bold mb-0">{{ child.first_name }} {{ child.last_name }}</h6>
                  <p class="text-muted small mb-0">Age {{ child.age }} â€¢ {{ child.gender }}</p>
                </div>
              </div>

              <div class="d-flex justify-content-between small text-muted mt-2">
                <span>Born:</span>
                <span>{{ child.date_of_birth|date:"M j, Y" }}</span>
              </div>

              {% if not child.is_eligible %}
                <div class="status-bar not-eligible-bar rounded-2 text-center py-1 small fw-semibold mt-2">
                  Not Eligible â€“ Age {{ min_age }}â€“{{ max_age }} Required

                </div>
              {% elif child.already_enrolled %}
              <div class="status-bar not-eligible-bar rounded-2 text-center py-1 small fw-semibold mt-2">
                Already Enrolled in {{ child.enrolled_academy.name }}
              </div>

              {% else %}
                <div class="status-bar rounded-2 text-center py-1 small fw-semibold mt-2">Eligible</div>
              {% endif %}
            </div>
          </div>

        {% empty %}
          <p class="text-center text-muted">You donâ€™t have any registered children yet.</p>
        {% endfor %}
      </div>

      <div class="text-center mt-4">
        <button type="submit" id="continueBtn" class="btn btn-success px-5">Continue with 0 Children Selected</button>
        <a href="{% url 'academies:detail' academy.slug %}" class="btn btn-outline-secondary px-5">Cancel</a>
      </div>
    </form>
  </div>
</div>


<!-- Script -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const cards = document.querySelectorAll('.child-card');
  const button = document.getElementById("continueBtn");
  const selectionStatus = document.getElementById("selectionStatus");
  const childCountSpan = document.getElementById("childCount");

  function updateUI() {
    const checked = document.querySelectorAll('.child-checkbox:checked').length;

    // Update button text
    button.textContent = `Continue with ${checked} Child${checked !== 1 ? "ren" : ""} Selected`;

    // Update "X child selected" in header
    childCountSpan.textContent = checked;

    // If none selected â†’ hide the selection status
    if (checked > 0) {
      selectionStatus.classList.remove("d-none");
    } else {
      selectionStatus.classList.add("d-none");
    }
  }

  // âœ… Handle card click (only once, with eligibility check)
  cards.forEach(card => {
    card.addEventListener("click", function(e) {
      const checkbox = card.querySelector(".child-checkbox");
      const status = card.querySelector(".status-bar");

      // ðŸš« Skip if not eligible
      if (card.classList.contains("not-eligible")) {
        return;
      }

      // Prevent double toggle when clicking directly on checkbox
      if (e.target === checkbox) {
        updateUI();
        return;
      }

      // Toggle checkbox programmatically
      checkbox.checked = !checkbox.checked;

      // Update styles
      if (checkbox.checked) {
        card.classList.add("selected");
        status.textContent = "Selected";
      } else {
        card.classList.remove("selected");
        status.textContent = "Eligible";
      }

      updateUI();
    });
  });

  updateUI(); // initialize
});
</script>


<style>
  /* Default avatar */
.avatar-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #f8f9fa;
  color: #6c757d;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Selected card style */
.child-card.selected {
  border: 2px solid #198754 !important; /* green border */
  background: #eafaf1; /* light green background */
}

.child-card.selected .avatar-circle {
  background: #198754;
  color: #fff;
}

.child-card.selected .status-bar {
  background: #198754;
  color: #fff;
}

.child-card .status-bar {
  background: #f8f9fa;
  color: #6c757d;
}

.child-card {
  transition: all 0.2s ease;
}

/* Hover effect */
.child-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.05); /* subtle shadow */
  cursor: pointer;
}

/* Custom outline-success button */
.btn-custom {
  border: 1.5px solid #198754;   /* Bootstrap green */
  color: #198754;
  background-color: #f8fdfb;     /* very light green background */
  font-weight: 500;
  border-radius: 8px;            /* rounded corners */
  padding: 6px 18px;
  transition: all 0.2s ease;
}

/* Hover effect */
.btn-custom:hover {
  background-color: #198754;     /* solid green */
  color: #fff;
}

.btn-custom:hover i {
  color: #fff;                   /* make icon white too */
}

.membership-badge {
  background-color: #e6f9f0;  
  color: #198754;            
  border: 1px solid #c6f1dd; 
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  border-radius: 50rem; /* pill */
}

/* Disabled/Not eligible card */
.child-card.not-eligible {
  cursor: not-allowed !important;
  background: #fbeaea; /* light red background */
  opacity: 0.8;
}

.child-card.not-eligible .avatar-circle {
  background: #dc3545;
  color: #fff;
}

.status-bar.not-eligible-bar {
  cursor: not-allowed !important;
  background: #dc3545;
  color: #fff;
}



</style>
{% endblock %}

